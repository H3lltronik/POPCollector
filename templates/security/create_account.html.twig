{% extends 'base.html.twig' %}

{% block title %}Log in!{% endblock %}

{% block body %}
    <el-form id="form" :loading="loading">
        {% if app.user %}
            <div class="mb-3">
                You are logged in as {{ app.user.username }}, <a href="{{ path('app_logout') }}">Logout</a>
            </div>
        {% endif %}

        <h1 class="h3 mb-3 font-weight-normal">Registro</h1>
        <label for="inputEmail">Email</label>
        <input type="email" value="" name="email" id="inputEmail" class="form-control" required autofocus>
        <label for="inputPassword">Contraseña</label>
        <input type="password" name="password" id="inputPassword" class="form-control" required>
        <label for="inputPassword">Confirmar contraseña</label>
        <input type="password" name="password2" id="inputPassword2" class="form-control" required>

        <div><label >Tipo de cuenta</label></div>
        <div class="form-check">
            <label class="form-check-label">
                <input type="radio" class="form-check-input" name="accountType" value="buyer">Comprador
            </label>
            </div>
            <div class="form-check">
            <label class="form-check-label">
                <input type="radio" class="form-check-input" name="accountType" value="seller">Vendedor
            </label>
        </div>

        <input type="hidden" name="_csrf_token"
            value="{{ csrf_token('authenticate') }}"
        >

        <div class="d-flex mt-lg-4">
            <button id="crearCuenta" class="btn btn-sm btn-primary" type="submit">
                Crear cuenta
            </button>
            <a href="{{ path('app_login') }}">
                <button class="btn btn-sm btn-info" type="button">
                    Iniciar sesion
                </button>
            </a>
        </div>
    </el-form>
{% endblock %}

{% block javascripts %}
    <script>
        let vueInst = new Vue({
            el: "#form",
            data () {
                return {
                    loading: false,
                }
            },
            created () {
            },
            methods: {
                setLoading (status) {
                    this.loading = status
                }
            }
        })
        $(document).ready(() => {
            $("#form").submit((e) => {
                e.preventDefault();

                let email = $("#inputEmail").val();
                let password = $("#inputPassword").val();
                let accountType = $("input:radio[name ='accountType']:checked").val();

                console.log($("#inputPassword").val(), $("#inputPassword2").val(), $("#inputPassword").val() === $("#inputPassword2").val())
                if (password  === $("#inputPassword2").val() ) {
                    console.log("Ira nomas voy a crear un usuario")
                    vueInst.setLoading(true)
                    $.post("{{ path('app_user_save') }}", {email, password, accountType})
                    .done(() => {
                        vueInst.setLoading(false)
                        vueInst.$notify({
                            title: 'Éxito',
                            message: 'Se han creado el usuario',
                            type: 'success'
                        });
                        setTimeout(() => {
                            document.location.replace("{{ path('app_login') }}")
                        }, 1000);
                    })
                    .fail((e) => {
                        vueInst.setLoading(false)
                        console.error(e);
                        vueInst.$notify({
                            title: 'Error',
                            message: 'Se ha producido un error.',
                            type: 'error'
                        })
                    })
                } else {
                    vueInst.$notify({
                        title: "Error",
                        message: "Las contraseñas no coinciden",
                        type: "error",
                    })
                }
            })
        })
    </script>
{% endblock %}